<Window x:Class="OverlayApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:OverlayApp"
        mc:Ignorable="d"
        Title="VNTextMiner" Height="150" Width="800"
        WindowStyle="None" AllowsTransparency="True" Background="#CC1E1E1E"
        Topmost="True" ResizeMode="CanResizeWithGrip"
        MouseDown="Window_MouseDown" Loaded="Window_Loaded" Closed="Window_Closed">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="#252526"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="25"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar / Header -->
        <Border Grid.Row="0" Background="#2D2D30" MouseDown="Window_MouseDown">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="5,0,0,0">
                    <TextBlock Text="VNTextMiner" Foreground="#CCCCCC" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock x:Name="StatusText" Text="Initializing..." Foreground="Gray" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,5,0">
                    <Button Content="⚙" Click="Settings_Click" Background="Transparent" Foreground="White" BorderThickness="0" Cursor="Hand" Width="25"/>
                    <Button Content="✕" Click="Close_Click" Background="Transparent" Foreground="#FF5555" BorderThickness="0" Cursor="Hand" Width="25"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Text Area -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <ItemsControl x:Name="TextContainer" Margin="5">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Click="Word_Click" Tag="{Binding}" Margin="1" 
                                Background="Transparent" BorderThickness="0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" CornerRadius="3" Padding="2">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Surface}" FontSize="18" Foreground="White" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Settings Panel -->
        <Border x:Name="SettingsPanel" Grid.Row="1" Background="#252526" Padding="10" Visibility="Collapsed" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,0,5,0" BorderBrush="#3F3F46" BorderThickness="1" CornerRadius="0,0,5,5">
            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="600">
                <StackPanel Width="280">
                    <Grid Margin="0,0,0,10">
                        <TextBlock Text="Settings" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                        <Button Content="🔄 Refresh Lists" Click="RefreshLists_Click" HorizontalAlignment="Right" Background="#333" Foreground="White" BorderThickness="0" Padding="5,2" FontSize="10" Cursor="Hand"/>
                    </Grid>

                    <CheckBox x:Name="ChkPause" Content="Pause Monitoring" Foreground="White" Margin="0,0,0,10" Checked="ChkPause_Checked" Unchecked="ChkPause_Checked"/>

                    <!-- NEW: Window Selection -->
                    <TextBlock Text="Target Game (for Screenshot):" Foreground="Gray"/>
                    <ComboBox x:Name="CmbWindows" Margin="0,0,0,10" DisplayMemberPath="Title" SelectionChanged="CmbWindows_SelectionChanged"/>

                    <TextBlock Text="Anki Deck:" Foreground="Gray"/>
                    <ComboBox x:Name="CmbDecks" IsEditable="True" SelectionChanged="CmbDecks_SelectionChanged" Margin="0,0,0,10"/>

                    <TextBlock Text="Note Type:" Foreground="Gray"/>
                    <ComboBox x:Name="CmbModels" IsEditable="True" SelectionChanged="CmbModels_SelectionChanged" Margin="0,0,0,10"/>

                    <!-- Mappings -->
                    <Border Background="#333" CornerRadius="5" Padding="5" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock Text="Field Mappings:" Foreground="#61AFEF" FontWeight="Bold" Margin="0,0,0,5"/>
                            <ItemsControl x:Name="FieldMappingControl">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,0,0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="110"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{Binding FieldName}" Foreground="White" VerticalAlignment="Center" ToolTip="{Binding FieldName}" TextTrimming="CharacterEllipsis"/>
                                            <ComboBox Grid.Column="1" SelectedItem="{Binding SelectedToken}" SelectionChanged="MappingCombo_SelectionChanged"
                                                      ItemsSource="{Binding AvailableTokens}" Height="22" FontSize="11"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <TextBlock Text="Background Opacity:" Foreground="Gray" Margin="0,5,0,0"/>
                    <Slider x:Name="OpacitySlider" Minimum="0.1" Maximum="1.0" Value="0.8" 
                            TickFrequency="0.1" IsSnapToTickEnabled="True"
                            ValueChanged="OpacitySlider_ValueChanged" Margin="0,0,0,10"/>

                    <Button Content="Test Anki Connection" Click="TestAnki_Click" Background="#333" Foreground="White" BorderThickness="0" Padding="5"/>
                    <TextBlock x:Name="AnkiStatus" Margin="5,5,0,0" HorizontalAlignment="Center" FontSize="10"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Dictionary Popup -->
        <Popup x:Name="DictPopup" Placement="MousePoint" StaysOpen="False" AllowsTransparency="True">
            <Border Background="#1E1E1E" BorderBrush="#333" BorderThickness="1" CornerRadius="5" MaxWidth="500" MaxHeight="400"
                    PreviewMouseWheel="Popup_PreviewMouseWheel">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="3" Opacity="0.5"/>
                </Border.Effect>

                <!-- Scroll Viewer for List -->
                <ScrollViewer x:Name="DictScrollViewer" 
              VerticalScrollBarVisibility="Auto" 
              HorizontalScrollBarVisibility="Disabled"
              PanningMode="VerticalOnly"
              CanContentScroll="False"
              PreviewMouseWheel="Popup_PreviewMouseWheel"
              Height="280"
              Margin="0,10,0,0">

                    <!-- Custom Scrollbar Style -->
                    <ScrollViewer.Resources>
                        <Style TargetType="ScrollBar">
                            <Setter Property="Background" Value="#333"/>
                            <Setter Property="Width" Value="12"/>
                            <!-- Wider scrollbar -->
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ScrollBar">
                                        <Grid x:Name="GridRoot" Width="12" Background="#222">
                                            <Track x:Name="PART_Track" IsDirectionReversed="true" Focusable="false">
                                                <Track.Thumb>
                                                    <Thumb>
                                                        <Thumb.Template>
                                                            <ControlTemplate TargetType="Thumb">
                                                                <Border Background="#666" CornerRadius="4" Margin="2"/>
                                                            </ControlTemplate>
                                                        </Thumb.Template>
                                                    </Thumb>
                                                </Track.Thumb>
                                            </Track>
                                        </Grid>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ScrollViewer.Resources>

                    <!-- Content -->
                    <ItemsControl x:Name="PopEntries">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#2b2b2b" CornerRadius="8" Margin="0,0,5,10" Padding="15" BorderBrush="#444" BorderThickness="1">
                                    <StackPanel>
                                        <!-- Header: Word + Reading -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="{Binding Headword}" FontSize="24" FontWeight="Bold" Margin="0,0,10,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <!-- Default Color (Blue) -->
                                                        <Setter Property="Foreground" Value="#61AFEF"/>
                                                        <Style.Triggers>
                                                            <!-- If IsKnown == True, Change to Green -->
                                                            <DataTrigger Binding="{Binding IsKnown}" Value="True">
                                                                <Setter Property="Foreground" Value="#98C379"/>
                                                                <!-- Anki Green -->
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Text="{Binding Reading}" Foreground="#98C379" FontSize="18" VerticalAlignment="Bottom" Margin="0,0,0,4"/>

                                            <!-- Add Button (Top Right) -->
                                            <Button Content="Add +" 
                                    Click="AddSpecificEntry_Click" 
                                    Tag="{Binding}"
                                    Width="60" Height="25"
                                    FontSize="12"
                                    Background="#333" Foreground="#FFF" BorderBrush="#555"
                                    HorizontalAlignment="Right" Margin="20,0,0,0"
                                    Cursor="Hand">
                                                <Button.Resources>
                                                    <Style TargetType="Border">
                                                        <Setter Property="CornerRadius" Value="4"/>
                                                    </Style>
                                                </Button.Resources>
                                            </Button>
                                        </StackPanel>

                                        <!-- Rich Dictionary Content -->
                                        <RichTextBox IsReadOnly="True" Background="Transparent" BorderThickness="0" Foreground="#DDD" local:RichTextBoxHelper.Document="{Binding DefinitionDocument}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Popup>

    </Grid>
</Window>